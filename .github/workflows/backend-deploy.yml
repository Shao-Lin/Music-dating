name: üöÄ Deploy Backend

on:
  push:
    branches: [tpproj-21]  # –∏–ª–∏ –≤–∞—à–∞ —Ä–∞–±–æ—á–∞—è –≤–µ—Ç–∫–∞
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Backend Service
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # üîÑ –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –í—Å–µ –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git log

      # üìÅ –®–∞–≥ 2: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ)
      - name: üìÅ Check Files Locally
        run: |
          echo "–§–∞–π–ª—ã –≤ backend/server:"
          find backend/server -type f -name "*.kt" -o -name "*.gradle" -o -name "*.yaml"

      # üßπ –®–∞–≥ 4: –û—á–∏—Å—Ç–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
      - name: üßπ Prepare Server Environment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤..."
            sudo rm -rf /home/deployer/music-dating/backend/server/*
            sudo chown -R deployer:deployer /home/deployer/music-dating/backend/server

            echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)..."
            # sudo apt install -y openjdk-21-jdk gradle  # –ï—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ

      # üåê –®–∞–≥ 5: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üåê Clone Repo on Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server

            echo "–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            git init
            git remote add origin git@github.com:<–≤–∞—à-–ª–æ–≥–∏–Ω>/<–≤–∞—à-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π>.git
            git fetch origin main
            git reset --hard FETCH_HEAD
            git checkout main

            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
            ls -la

      # üèóÔ∏è –®–∞–≥ 6: –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
      - name: üê≥ Build & Start Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server/backend/server

            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker-compose down

            echo "–ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker-compose up -d --build --force-recreate

            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
            docker ps -a