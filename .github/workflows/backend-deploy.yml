name: ğŸš€ Deploy Backend

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Music-Dating Backend
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Checkout ĞºĞ¾Ğ´Ğ°
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        # ğŸ§ª Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
      - name: ğŸ§ª Check files in backend/server
        run: |
          echo "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ² backend/server:"
          ls -la backend/server/

          echo "JAR-Ñ„Ğ°Ğ¹Ğ»Ñ‹:"
          ls -la backend/server/build/libs/

      # ğŸ›  Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Java
      - name: ğŸ§° Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # ğŸ— Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      - name: ğŸ”¨ Build Project
        working-directory: ./backend/server
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/

      # ğŸ§¹ ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
      - name: ğŸ§¹ Clean and prepare server directories
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # ğŸ“‚ ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
      - name: ğŸ“‚ Copy Dockerfile
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/Dockerfile
          target: "/home/deployer/music-dating/backend/server/Dockerfile"
          overwrite: true

      - name: ğŸ“‚ Copy docker-compose.yaml
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/docker-compose.yaml"
          overwrite: true

      - name: ğŸ“‚ Copy JAR file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/build/libs/*.jar
          target: "/home/deployer/music-dating/backend/server/app.jar"
          overwrite: true

      - name: ğŸ“‚ Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/backend.server.env
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      # ğŸ³ Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
      - name: ğŸ”„ Restart Docker Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker ps -a

      # ğŸ“œ Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
      - name: ğŸ“œ Show Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose logs --tail=50