name: ğŸš€ Deploy Backend

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ğŸ”„ Ğ¨Ğ°Ğ³ 1: Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ´Ğ°
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      # ğŸ§ª Ğ¨Ğ°Ğ³ 2: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
      - name: ğŸ§ª Check Files Locally
        run: |
          echo "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ² backend/server:"
          ls -la backend/server/

      # ğŸ§¹ Ğ¨Ğ°Ğ³ 3: ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°
      - name: ğŸ§¹ Prepare Server Directories
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # ğŸ“‚ Ğ¨Ğ°Ğ³ 4: ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹
      - name: ğŸ“‚ Copy Dockerfile
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/Dockerfile
          target: "/home/deployer/music-dating/backend/server/Dockerfile"
          overwrite: true

      - name: ğŸ“‚ Copy docker-compose.yaml
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/docker-compose.yaml"
          overwrite: true

      # ğŸ› ï¸ Ğ¨Ğ°Ğ³ 5: Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº
      - name: ğŸ³ Build & Start Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker ps -a