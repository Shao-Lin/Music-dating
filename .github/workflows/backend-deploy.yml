name: 🚀 Deploy Backend (dev)

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest

    steps:
      # 🔄 Checkout кода
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: tpproj-21
          fetch-depth: 0

      # 🔧 Установка Java и Gradle
      - name: 🛠 Setup JDK & Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # 📦 Установка зависимостей и сборка проекта
      - name: 🏗 Build Project
        working-directory: ./backend/server
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/  # Диагностика: убедиться, что JAR создан

      # 🧹 Очистка целевой директории на сервере
      - name: 🧹 Clean target directory on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # 🚚 Копируем JAR, Dockerfile и docker-compose.yaml
      - name: 📂 Copy JAR and Docker files
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            backend/server/build/libs/*.jar
            backend/server/Dockerfile
            backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true

      # 📦 Копируем .env
      - name: 📂 Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/server/backend.server.env"
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      # 🐳 Перезапуск контейнеров
      - name: 🔄 Restart Backend Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose up -d --build --force-recreate
            docker ps -a

      # 📜 Логи при ошибке
      - name: 📜 Check Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker-compose logs --tail=100