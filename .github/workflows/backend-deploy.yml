name: üöÄ Deploy Backend

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Music-Dating Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # üîÑ –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥
      - name: üîÑ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: tpproj-21
          fetch-depth: 0

      # üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –ª–æ–∫–∞–ª—å–Ω–æ
      - name: üß™ Check files locally
        run: |
          echo "–§–∞–π–ª—ã –≤ backend/server:"
          ls -la backend/server/

          echo "JAR-—Ñ–∞–π–ª—ã:"
          ls -la backend/server/build/libs/

          echo "dockerfile –∏ docker-compose.yaml:"
          ls -la backend/server/dockerfile backend/server/docker-compose.yaml

      # üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Java –∏ Gradle
      - name: üß∞ Setup JDK & Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # üèó –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      - name: üî® Build Project
        working-directory: ./backend/server
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–Ω –ª–∏ JAR

      # üßπ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üßπ Clean target dir on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # üìÇ –ö–æ–ø–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üì¶ Copy Dockerfile
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/dockerfile
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true
          strip_components: 2

      - name: üì¶ Copy docker-compose.yaml
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true
          strip_components: 2

      - name: üì¶ Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/backend.server.env
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true
          strip_components: 2

      - name: üì¶ Copy JAR file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/build/libs/*.jar
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true
          strip_components: 3

      # üê≥ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: üîÑ Restart Docker Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server/docker-compose.yaml/backend/server
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker ps -a

      # üìú –õ–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      - name: üìú Show Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose logs --tail=50