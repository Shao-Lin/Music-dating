name: üöÄ Deploy Backend to Server

on:
  push:
    branches: [tpproj-21]  # –∏–ª–∏ –≤–∞—à–∞ –≤–µ—Ç–∫–∞
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Music-Dating Backend
    runs-on: ubuntu-latest

    steps:
      # üîÑ –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
      - name: üîÅ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: tpproj-21
          fetch-depth: 0

      # üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã
      - name: üìÅ Check files in backend/server
        run: |
          echo "–§–∞–π–ª—ã –≤ backend/server:"
          ls -la backend/server/
          echo "JAR-—Ñ–∞–π–ª—ã:"
          ls -la backend/server/build/libs/ || true

      # üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ JDK –∏ Gradle
      - name: üß∞ Setup Java & Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # üèó –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      - name: üõ† Build Project
        working-directory: ./backend/server
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–Ω –ª–∏ JAR

      # üßπ –û—á–∏—Å—Ç–∫–∞ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üßº Clean target directory on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # üöö –ö–æ–ø–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üìÇ Copy Dockerfile
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/Dockerfile
          target: "/home/deployer/music-dating/backend/server/Dockerfile"
          overwrite: true

      - name: üì¶ Copy docker-compose.yaml
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/docker-compose.yaml"
          overwrite: true

      - name: üìÑ Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/backend.server.env
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      - name: üìÅ Copy JAR file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/build/libs/*.jar
          target: "/home/deployer/music-dating/backend/server/app.jar"
          overwrite: true

      # üê≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: üîÑ Restart Containers via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose up -d --build --force-recreate
            docker ps -a

      # üìú –õ–æ–≥–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      - name: üìú Show Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose logs --tail=50