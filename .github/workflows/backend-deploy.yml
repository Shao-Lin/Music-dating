name: üöÄ Deploy Backend (Production)

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üîÑ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: tpproj-21
          fetch-depth: 0

      # üìÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —à–∞–≥: –≤—ã–≤–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
      - name: üìÅ Check Local Files (Debug)
        run: |
          echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞:"
          find . -type f -path "*/server/*" -name "*.kt" -o -name "*.gradle" -o -name "*.yaml" -o -name "*.jar"

      # üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
      - name: üßπ Clean Server Directory
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "–û—á–∏—Å—Ç–∫–∞ /home/deployer/music-dating/backend/server..."
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend/server/* || true
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chown -R deployer:deployer /home/deployer/music-dating/backend/server

            # üöö –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: üöö Deploy Source Code
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/server/"         # üìÅ –ò—Å—Ç–æ—á–Ω–∏–∫: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –∫–æ–¥–æ–º
          target: "/home/deployer/music-dating/backend/server"  # üìÅ –¶–µ–ª—å: –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          overwrite: true                   # ‚úÖ –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤

      # üì¶ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
      - name: üì¶ Deploy Environment File
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/.github/env-files/backend.server.env"
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      # üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
      - name: üîë Set Permissions
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            chmod 644 .env
            find . -type d -exec chmod 755 {} \;
            find . -type f -exec chmod 644 {} \;

      # üê≥ –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
      - name: üê≥ Build & Start Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            docker-compose down --remove-orphans

            echo "–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π —Å–±–æ—Ä–∫–∏..."
            docker-compose up -d --build --force-recreate
