name: ğŸš€ Deploy Backend (dev)

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Backend to Server
    runs-on: ubuntu-latest

    steps:
      # ğŸ”„ Checkout ĞºĞ¾Ğ´Ğ°
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: tpproj-21
          fetch-depth: 0

      # ğŸ”§ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Java Ğ¸ Gradle
      - name: ğŸ›  Setup JDK & Gradle
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      # ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      - name: ğŸ— Build Project
        working-directory: ./backend/server
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/  # Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°: ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ğ¾ JAR ÑĞ¾Ğ·Ğ´Ğ°Ğ½

      # ğŸ§¹ ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ†ĞµĞ»ĞµĞ²Ğ¾Ğ¹ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
      - name: ğŸ§¹ Clean target directory on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # ğŸšš ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ JAR, Dockerfile Ğ¸ docker-compose.yaml
      - name: ğŸ“‚ Copy JAR and Docker files
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            backend/server/build/libs/*.jar
            backend/server/Dockerfile
            backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/"
          overwrite: true

      # ğŸ“¦ ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ .env
      - name: ğŸ“‚ Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "backend/server/backend.server.env"
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      # ğŸ³ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¾Ğ²
      - name: ğŸ”„ Restart Backend Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose up -d --build --force-recreate
            docker ps -a

      # ğŸ“œ Ğ›Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
      - name: ğŸ“œ Check Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker-compose logs --tail=100