name: 🚀 Deploy Backend

on:
  push:
    branches: [tpproj-21]
    paths:
      - 'backend/**'

jobs:
  deploy:
    name: Deploy Music-Dating Backend
    runs-on: ubuntu-latest

    steps:
      # 🔄 Checkout кода
      - name: 🔄 Checkout Repository
        uses: actions/checkout@v4
        # 🧪 Диагностика локальных файлов
      - name: 🧪 Check files in backend/server
        run: |
          echo "Файлы в backend/server:"
          ls -la backend/server/

          echo "JAR-файлы:"
          ls -la backend/server/build/libs/

      # 🛠 Установка Java
      - name: 🧰 Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 🏗 Сборка проекта
      - name: 🔨 Build Project
        working-directory: ./backend/server
        run: |
          chmod +x gradlew
          ./gradlew --no-daemon clean build bootJar
          ls -la build/libs/

      # 🧹 Подготовка директорий на сервере
      - name: 🧹 Clean and prepare server directories
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -rf /home/deployer/music-dating/backend || true
            mkdir -p /home/deployer/music-dating/backend/server

      # 📂 Копируем по одному нужный файлам
      - name: 📂 Copy Dockerfile
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/Dockerfile
          target: "/home/deployer/music-dating/backend/server/Dockerfile"
          overwrite: true

      - name: 📂 Copy docker-compose.yaml
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/docker-compose.yaml
          target: "/home/deployer/music-dating/backend/server/docker-compose.yaml"
          overwrite: true

      - name: 📂 Copy JAR file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/build/libs/*.jar
          target: "/home/deployer/music-dating/backend/server/app.jar"
          overwrite: true

      - name: 📂 Copy .env file
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: backend/server/backend.server.env
          target: "/home/deployer/music-dating/backend/server/.env"
          overwrite: true

      # 🐳 Запуск контейнеров
      - name: 🔄 Restart Docker Containers
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            docker ps -a

      # 📜 Логи при ошибке
      - name: 📜 Show Logs on Failure
        if: ${{ failure() }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/deployer/music-dating/backend/server
            docker-compose logs --tail=50